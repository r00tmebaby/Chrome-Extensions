name: Browser Extensions CI/CD

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  # Discover all extensions and detect changes
  discover-extensions:
    runs-on: ubuntu-latest
    outputs:
      extensions: ${{ steps.discover.outputs.extensions }}
      matrix: ${{ steps.discover.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover extensions
        id: discover
        run: |
          # Find all directories with package.json (excluding root and node_modules)
          extensions=()
          for dir in */; do
            dir_name="${dir%/}"
            if [ -f "$dir_name/package.json" ] && [ -f "$dir_name/manifest.json" -o -f "$dir_name/src/manifest.json" -o -f "$dir_name/manifest.chrome.json" ]; then
              extensions+=("$dir_name")
            fi
          done
          
          # Create JSON array for matrix
          matrix_json=$(printf '%s\n' "${extensions[@]}" | jq -R . | jq -s .)
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          echo "extensions=${extensions[*]}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Discovered extensions:"
          printf '%s\n' "${extensions[@]}"

  # Test each extension in parallel
  test-extensions:
    runs-on: ubuntu-latest
    needs: discover-extensions
    if: needs.discover-extensions.outputs.matrix != '[]'
    strategy:
      matrix:
        extension: ${{ fromJson(needs.discover-extensions.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if extension changed
        id: changes
        run: |
          # Check if this extension or root files changed
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            changed=true
          elif git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q "^${{ matrix.extension }}/"; then
            changed=true
          elif git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q -E "^(package\.json|\.github/)"; then
            changed=true
          else
            changed=false
          fi
          echo "changed=$changed" >> $GITHUB_OUTPUT
          echo "ðŸ” Extension '${{ matrix.extension }}' changed: $changed"

      - name: Setup Node.js
        if: steps.changes.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        if: steps.changes.outputs.changed == 'true'
        working-directory: ${{ matrix.extension }}
        run: npm ci || npm install

      - name: Run lint checks
        if: steps.changes.outputs.changed == 'true'
        working-directory: ${{ matrix.extension }}
        run: npm run lint || echo "No lint script, skipping"
        continue-on-error: true

      - name: Run unit tests
        if: steps.changes.outputs.changed == 'true'
        working-directory: ${{ matrix.extension }}
        run: npm test

      - name: Validate manifest
        if: steps.changes.outputs.changed == 'true'
        working-directory: ${{ matrix.extension }}
        run: npm run verify || echo "No verify script, checking manifest manually..."
        continue-on-error: true

      - name: Manual manifest check
        if: steps.changes.outputs.changed == 'true'
        working-directory: ${{ matrix.extension }}
        run: |
          if [ -f "manifest.json" ]; then
            echo "âœ“ manifest.json found"
            cat manifest.json | python3 -m json.tool > /dev/null && echo "âœ“ Valid JSON"
          elif [ -f "src/manifest.json" ]; then
            echo "âœ“ src/manifest.json found"
            cat src/manifest.json | python3 -m json.tool > /dev/null && echo "âœ“ Valid JSON"
          fi

      - name: Run E2E tests
        if: steps.changes.outputs.changed == 'true'
        working-directory: ${{ matrix.extension }}
        run: npm run test:e2e || echo "No E2E tests configured"
        continue-on-error: true

      - name: Build extension
        if: steps.changes.outputs.changed == 'true'
        working-directory: ${{ matrix.extension }}
        run: npm run build:all || npm run build || echo "No build script configured"
        continue-on-error: true

      - name: Upload test coverage
        uses: actions/upload-artifact@v4
        if: always() && steps.changes.outputs.changed == 'true'
        with:
          name: ${{ matrix.extension }}-coverage
          path: ${{ matrix.extension }}/coverage/
          retention-days: 7
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: steps.changes.outputs.changed == 'true'
        with:
          name: ${{ matrix.extension }}-build
          path: |
            ${{ matrix.extension }}/build/
            ${{ matrix.extension }}/*.zip
          retention-days: 30
        continue-on-error: true

  # Create release packages for all extensions
  package-extensions:
    runs-on: ubuntu-latest
    needs: [discover-extensions, test-extensions]
    if: always() && needs.test-extensions.result == 'success'
    strategy:
      matrix:
        extension: ${{ fromJson(needs.discover-extensions.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ${{ matrix.extension }}
        run: npm ci || npm install

      - name: Create package
        working-directory: ${{ matrix.extension }}
        run: |
          # Try various packaging scripts
          if npm run package > /dev/null 2>&1; then
            npm run package
          elif npm run zip:all > /dev/null 2>&1; then
            npm run zip:all
          else
            # Create simple zip
            extension_name=$(echo "${{ matrix.extension }}" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
            if [ -f "manifest.json" ]; then
              zip -r "../${extension_name}.zip" . -x "node_modules/*" "tests/*" ".*" "package*.json"
            fi
          fi
        continue-on-error: true

      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.extension }}-package
          path: |
            ${{ matrix.extension }}/*.zip
            *.zip
          retention-days: 30
        continue-on-error: true

  # Summary report
  test-summary:
    runs-on: ubuntu-latest
    needs: [discover-extensions, test-extensions]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“Š Browser Extensions Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository**: Browser Extensions Monorepo" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Discovered Extensions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.discover-extensions.outputs.extensions }}" | tr ' ' '\n' | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Extension Tests | ${{ needs.test-extensions.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.test-extensions.result }}" = "failure" ]; then
            echo "âŒ **Some tests failed. Check the logs above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… **All tests passed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "- Review test coverage reports" >> $GITHUB_STEP_SUMMARY
            echo "- Download build artifacts for publishing" >> $GITHUB_STEP_SUMMARY
            echo "- Merge when ready" >> $GITHUB_STEP_SUMMARY
          fi

